sudo: required
services:
- docker
env:
  matrix:
  - THINKEHR_VER=2.3.22
  global:
  - secure: HSSUbJteG8USxkiLqwkEm+SQtn53IIOuI7nblz+xhYPLNGhVogMmM4Buf0F1vaFbILD1h64rZcYW5dd2W6rxbPLwn1YrvX3X1BFsZTA/+2xZ3+EQNM/0An4xEhEu19FqS8cIeadtSwFc+9kW6U5drxZgl4URhZEi89LvF7mJolfo/L56ZC0QXDqeizy0AAGwfxPTI0wV/m7t+8zDNr68Gr4XUm3FL0otLxk52HIRGtCmb+dD0Sab3UMV20sekrlGbCFqXr8ZBcjfNvUvrXz0nyCQCBY+FVSbFc2S1uV0hKmebvHD60QxTY1/ZLDoQ5BdEW20bgmb9nlDb29umS89i3aS/nDXRm0aF10AQW0VLYUqgES+267kGvk6xBLtpJflSR7MGgr+PfKPr9GvpWCFtexGNwxIS2Z6eNn4PjqBqXPI9pB74DA6Sjsg8J37k3gz5cXJqtCDjtVvHexYNhwMowBluRrjQ8hTTU+EcJBRASKj1MQ+lgvBeqH5IBKi00anVMS8zOZ8AU1eDbcqP6IOjZ9ux5w9H4Z16+lGmfBj6URyw/iJTPctDG0k+ggeE1aG+g2izBE01jlZU5fgnipJPPl5lPC7CJCUIcweyCjwzLLrUGEOhf99hPYcarq9DPvzvwkE5eF3EA/OifG2qM017/SNglBqLSHR4NywUNFaZxY=
  - secure: La8pAzj0m0YOZquxkG03xn8PlA6eqz1KGz3MNlC6izTOM+nVQj0VeidvdxA8uyasuRTPzzzPwr5l9HFYp4XiHbWsuLkYxnwZvKWym00R7WRpC2uqPStHJA7j/ZH7NPhI5KYMLRkOcFvJh5svoe0CvvCMZsa2FdSzhl1SVv9AStBQHQEWFbV5aLKJtSSmKLBkfoGLiAc3GeKVclFc44vcNGYQdQBu6LdR79x3f8Ef6UW2eEo/7vrtGeH7MzjM40g7TEtNvoiSqbXfsNwtDVhfcJx0hWuwBI3hnUzmFwd3dID1hwKllQ6tU0ZidUbO7zob3g3oSRneedfP9t01aY0W9x8vFablrMrKJ5ps0xtN3Oi4gRm8Rxde3pUIeDg4U/mDnmnK6GHLHPBT/VvUzeXc1pFQlnBAKfDmBLk4dObL2dfQ2yR8PiFuJShdMdFhcrQha0Lvp7GwB29t4lPGC2f4ok/cgE7Wvxb8f2pjT6sf9Jdy2YRI3SUalnBSZJZ8AxtmnmtSRrKhG76WpcJ3kDBlOQQM36AhBxDKv3xKG3OJM+J9xdEnBKUqkaAJ4HgYQf4Qz6YHA2D4M4HFOa/wDOI7zKkcekOMJLRfklBFYunGth+/iFwzCcLEXgbca6ToDBXBr8laRBAGXxiAUZvhu64yr3/VMpkqP0+IA6eOaqEcj1s=
  - secure: U/2Kf5DaSRVCKLUIE15oHbCZX4x5u4f+KOyioYWBy6t3aYrGrisma0/1EzWKR8MX/jm/hJ3xHS2axknLrP165+hVyr2W/p12D3QY6M39jUSCdlrS75VaEmHxudASDI/kUzi/f5rJKU64lEBJr+Z/E3zezS93IScu2X25szjDRmVVmZce7Z1hzjsBps0zibJ1oaoChB7t+bZX1DcIN7wrfh+ka2tCI5DenddpbjBC9S6CjmneGTrSk/1X9gePw7fOxxOUzUwGs1zTgvOWcTf7XBrFPmlCPSrVTNn1BHHqj/CTTcVPW5jSdjliQ25jklQBGU+10FuapSGnTmbDPl3lqqzxk9CZVQu7Dbx+LUXot7xzMZHbqtykQWmaSsdR7E7RK2/DmDbXGQCyDTY6rl/YvYNWOfFhrZSlUvFnJ8fNi1pTa7nRm1YBRWDuRj9b+aT5y/rAvi76fHzByXrZJ8Pe26qWkU18t4PM5O6dSaIsLXbe2sjS4z4o7n681K0DAnq+PQOtHKXVjlA67Eh8UHT/t/+qe8j4HiE42ZG1tND9R6HHRCeIl8VeWsBOQGmyAIYMAhZkBjj2mI5hEwL/XRRbxNt9ReaPAiQt+54Y35RATOq7/AHL+MtS+Wl6j49MwPxs/NjBX69zNsEGqcPJUk6K6M50uWW8/voNS81QES3lrfs=
  - secure: vFXVi+w44pnpAqimrhxL5rvedufqk3PMNwIBfQdGLNNcIsWZMJ3ajmnh32i/chdU8hBso8bDeoycUeDojC7G7zRc8OBSM1ZOTtplKIFMluB69I1r1xTPbYFnltSrP1KfoPxlPax/HPPI1uEvbqhQX+POJZD+8uyDJQA03ptoJWXj5uK5VWMQlhM3ixTCmWJVP6FIFHv41LXI5qva037EtBZksAmu2ivSrmNy7MHT8ZmnILSy9Fa6s1AJ09RqVCClwCsPLLg+3YA4pHcXb3GZtjRZ3iHFnSd6qBWwge8bb6i3UpoGpEP14SR7INYYRxyKt+L8s5zl/cVJohxrVewauKnsXDHlmbP1re2OtGYZoVU4oMpxgzdOcCeBOOxhwCe9wCGF9caYc6WrfFeAM9tWLAQbGdqdgLcxiCnzLJjLWVQ2SYKZIb7N9l7h8UW4cglcTMlMzFMy77xD5Lve4CTA7bGU1NhWSGKRImwum8WbaE+WTcF7IoDTX+G6HCiLn8iaFGjc3/K2NxLLeNXCklD/Ob4JxqEmP8H8r031PXKaVcvJxPVbZXCDe2KXDCjLESZhe8KIEYqURUaopVI2cbkmIn/oOqoZJEbUDL370DFCW4c6S4XPmYEAhphAQzJCx532A9HtK5Pi688VgbW/T4USev/VD1HkzjV1Z033NhGC264=
before_script:
- wget https://$SOURCE_URL/source/marand/files/thinkehr-server-jsw-$THINKEHR_VER.tar.gz
  && tar zxf thinkehr-server-jsw-$THINKEHR_VER.tar.gz -C thinkehr && rm thinkehr-server-jsw-$THINKEHR_VER.tar.gz
- wget https://$SOURCE_URL/source/marand/files/thinkehr-server-$THINKEHR_VER.tar.gz
  && tar zxf thinkehr-server-$THINKEHR_VER.tar.gz -C thinkehr && rm thinkehr-server-$THINKEHR_VER.tar.gz
script:
- envsubst < Dockerfile > Dockerfile.$THINKEHR_VER
- docker build -f Dockerfile.$THINKEHR_VER --tag marand-thinkehr-server .
- docker run --name thinkehr-db -e POSTGRES_USER=thinkehr -e POSTGRES_PASSWORD=thinkehr
  -e POSTGRES_DB=thinkehr -d postgres
- docker run --name thinkehr-server -v $PWD/conf/:/thinkehr/conf/ --link thinkehr-db:postgres
  -it marand-thinkehr-server ./bin/initdb.sh
after_script:
- docker images
- docker tag marand-thinkehr-server $REGISTRY_URL/marand-thinkehr-server:$THINKEHR_VER
before_deploy:
- docker login $REGISTRY_URL -u "$REGISTRY_USER" -p "$REGISTRY_PASS"
deploy:
  provider: script
  script: docker push $REGISTRY_URL/marand-thinkehr-server:$THINKEHR_VER
  on:
    branch: feature-thinkehr-server
