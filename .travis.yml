sudo: required
services:
- docker
env:
  matrix:
  - THINKEHR_VER=2.3.22
  global:
  - secure: lG4acVTJxF4h9EbtnVHfviY6YaDe8x5kPZQnsvr9liZv6yiICOARZaj20iRSPAQ4TF/kDyHt/aYDTRDWxxBO6C6h+7wDiJZtMiIDF8iJRqT/5sKH4k7/ZkmXZGixCa3EIexG65HHZLAbWzzEyaGu5AWMU7ctmLEjMHvs0H5anBAAPY2VH1lYpuNHq40dFN3xVtDY6PkX1MB/zzYoaXT9JuBxTSqV0DbDd4DVL8kE3cing/f76mSBXwGHyYTQ/BHlvJRHdkLatIr6OjWf46drfn/jayxjVQ+N9qOOuL277rG/LmXb8Vq/phaMcdHaX0pVXJnUB0/C+dhmE4Md7jlmfDBpN07z5xfIoipA5RcbgybDhq2tZ2Cl3ALNq69sGjF2WUQ/tgcYDp8MSA2bq0iMl284dKCKLI0VwqIw/jx3r2ST+OOlfNj6IEEuZNRB9Ww2pT6sfEkL8zUbbniuvXaRkZzUfNkeH2qulaEFcocl/RmvktZxDxbW2BByM8YGnIPu/Xpvg9pzbTSvxFForSb5Mr5VOPm1z28GzFLd1xqntzbYXTatEAXBqoNcS8hoq6eKme27lkevEVTaM4GXdPafSfNKm39/b2SysaqzLhrH9Q8Fd1knRGJgOjfweAPkC/KGoa0INEpAPrneI31FPvfA+DXEfE3YdRWas4wzYVIKMrU=
  - secure: w9QUxk9ybES13QDZvIHo3UN5y35DMCBxCHXlWqrvag7ZFKanmRdY/XaXRQB7/XTy4IHPMSA+Xh0y9BsEqEccmIvzN5WiEB4RQwc2f5VOgOiUUDHV2Qb4rsdJFtsXUynC39+Kh7lHgQo6hymrsnNiOcK3BhrKBbyyYqJPB0a2iqYahMs4qXnuQ65oJI7yYRdhhY2UnkBc3i48bvnWGNyGCIL39cE2fxS401gJ061w0V7YrGB7vFXuCKaaVzwrCBxz1C6f5k1UV7jmCvSSRtyyzNxsbv439bvzaHyUO39m62PfsE8pHfe5XQIbFt1Jvi7omZxVvLcTLPtuwdDJwnWNAU8YGZ5OjhDE+etMcqVd1sdZADyvmjHRqEYSt0FfhE073zvLmln9E/wzI58usARoUvbiu/9Q1oUulhRE24wEQamoG7Dkes/q6iNb/Pmwm7TSzn2hL6rjMfJuzKvURJDKXfOw9QrdPUiBDzrLUwtipDb9qErP7Xik+4o7wuosRb7JN0lPfMFNF7jM//IZschmpp8foTa6nX8KZE9OiEEPD7bU6GwrjqyXUhFdTBMCBWYgi13lbLJyZnOBxvuFPNfTH+Xq3BtOxKqUi2dCutd826ekJ9pJqoDbJxQLaH4G29Hw2rjHKsfFdsbV6rjdfrFIJYNrGbvZBj6HbhkOp3IXp5M=
  - secure: t4hUChK+1y7vx61nmp/IkcsqdQlbfM/SlJEXaubA3TPTI9tr4nwZFt/gh2kKdjp2K4Q4l6R2jEhkFYA1owGp/Sa8z/0DqEf70PGlNUZHbiM1HsXrgq/WuilGVZXLx9T1pD/8Mr9YkfIrSQUePPDUQSQw0HsJ0pA74QF52D25XhpDimcDjN33k+JDXgCo87A5nR8IieZOmKcviI2BHMbs8fsrMjc2WzRvqM88QOV6lM1L4D4Q6zREzCDtpvPYR+RSk3GvbcQP97OkWfoMye0j0w9j11vJrc0dlCrpw5X/s+oBwAz+OpAuk/n59jOdph0VbkNl8GB11EaNh/wLan7f/3HL7/AjmwDKgiNQ7eDcroRKOMedP68dJ+J/R+o8w/OCwJADSj0I+kW8prf6yS380ezMHN59dxRAHoJ3pSro2C6V0BQAR7b40gFdI1l4EgYV+37pTQSAXpbVaOwj/3Lqo6lNDqDAsIw1QqsiPgn/iQCNn613mhwbDUCnP6W25UyOw+IS5Gun9xhK7Zi5W5phOccxdYyIAwxyQ6emOIZcpn7d2xlJ1ZVxiN4Pyu7RJCyU3oh7AfQP7VR701yqNiUNS6qxomMptvFrkka65IxdPrUTdoJoZQoMl7uSL50UXoFQ/hv72VGHd7LVHZttRzne7TyXOoh8e7/1OkxLPEOT78c=
  - secure: srxMPldQO8HdmWY29PsnHUPeTaAIVBzzNIVOkUI6kqEE35VLchLDfpLSFNuDkYSsJzYMlciE5fMwlWqXYxlEo4/bYAip/e23s1EfCrEDk6ao+JBpAWRRueWsb5XGDU0qZ4Joiw8FuHIToj37ggSn0ME0i+ZiCFrJ6E3ff/RYB8p7DDwqvzgARgCfUwqWO1u0kyZidxNV1/uLQy9V4YoThxhwyR10+526afXk+G6+Rgnm2szrc0XBAvnU729Z3NQ3D7A6tXip02Ff6z/Ygk9DmhkktNhrm+3GJOOUD3513cN7VuXjQTC4wXMp8k1ES5ejWPk8NwdvJVqHvcEV4x28A0PAYXYE96hSgoRcARKp0RdwO3WQTuDCHpN/Yrm+4XqhBTRHV6yuzzWOmAc379Dpvp8SCRimm/v0x6QhmS0O5sWFB1H003D3VHlCA9ErphAJxydkzVa80Tn4Ee5LwYj3z5Hf1yWe9QnMD5c1AGISDUOlhyOt5Sp+V7c2QX+Lnv7ariugpQA2cIbooFoJeOrFPXKyGcLm1y7negvVlAunDl2DvfHb3Ef/w7RzS/PV/ryMsELY5ZCKhbMYHUqS9UXKa5fQGAp5T05AwBcXwZpy5S8hlz57TaJBUy+4OBFHQFiy4ZW7M2bMlQxBTvzb0u/eCdYjI30028roKwVEUYVbOJI=
before_script:
- wget https://$SOURCE_URL/source/marand/files/thinkehr-server-jsw-$THINKEHR_VER.tar.gz
  && tar zxf thinkehr-server-jsw-$THINKEHR_VER.tar.gz -C thinkehr && rm thinkehr-server-jsw-$THINKEHR_VER.tar.gz
- wget https://$SOURCE_URL/source/marand/files/thinkehr-server-$THINKEHR_VER.tar.gz
  && tar zxf thinkehr-server-$THINKEHR_VER.tar.gz -C thinkehr && rm thinkehr-server-$THINKEHR_VER.tar.gz
script:
- envsubst < Dockerfile > Dockerfile.$THINKEHR_VER
- docker build -f Dockerfile.$THINKEHR_VER --tag marand-thinkehr-server .
- docker run --name thinkehr-db -e POSTGRES_USER=thinkehr -e POSTGRES_PASSWORD=thinkehr
  -e POSTGRES_DB=thinkehr -d postgres
- docker run --name thinkehr-server -v $PWD/conf/:/thinkehr/conf/ --link thinkehr-db:postgres
  -it marand-thinkehr-server ./bin/initdb.sh
after_script:
- docker images
- docker tag marand-thinkehr-server $REGISTRY_URL/marand-thinkehr-server:$THINKEHR_VER
before_deploy:
- docker login $REGISTRY_URL -u "$REGISTRY_USER" -p "$REGISTRY_PASS"
deploy:
  provider: script
  script: docker push $REGISTRY_URL/marand-thinkehr-server:$THINKEHR_VER
  on:
    branch: master
